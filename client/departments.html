<!DOCTYPE html>
<html>

<head>
    <title>Department</title>
</head>
<script>
async function getAllDepartments()
{
    document.getElementById('loggedUser').innerHTML = `Hello, ${JSON.parse(sessionStorage.getItem('userInformation'))?.fullname}`
    let resp = await fetch('http://localhost:5000/departments', {headers : {"x-access-token" : sessionStorage.getItem("token"), "userInformation" : sessionStorage.getItem("userInformation")}})
    let data = await resp.json()
    
    if (!Object.keys(data).includes("error"))
    {
        const tbody = document.getElementById("tbody")
        data.forEach(department => {
                                        let newDepartmentRow = document.createElement('tr')

                                        let name = document.createElement('td') 
                                        let link  = document.createElement('a')
                                        link.href = "EditDepartment.html?dname=" + department.name
                                        link.innerText = department.name
                                        name.appendChild(link)                             

                                        let manager = document.createElement('td')
                                        manager.innerText = department.manager

                                        let employees = document.createElement('td')
                                        let employeesList = document.createElement('ul')
                                        //a loop which goes over the employees array and create list
                                        
                                        if (department.employeesList.length > 0)
                                        {
                                            department.employeesList.forEach(name => {
                                                let singleEmployee = document.createElement('li')
                                                const [fname, lname] = name.split(" ")
                                                link = document.createElement('a')
                                                link.href = `EditEmployee.html?fname=${fname}&lname=${lname}&empDepartmentID=${department.departmentID}`
                                                link.innerText = name
                                                singleEmployee.appendChild(link)
                                                employeesList.appendChild(singleEmployee)
                                            });
                                            
                                        }
                                        else
                                        {
                                            let singleEmployee = document.createElement('li')
                                            singleEmployee.innerText = "No Employees Yet"
                                            employeesList.appendChild(singleEmployee)
                                        }

                                        employees.appendChild(employeesList)
                                        
                                        newDepartmentRow.appendChild(name)
                                        newDepartmentRow.appendChild(manager)
                                        newDepartmentRow.appendChild(employees)
                                        tbody.appendChild(newDepartmentRow)
        });
    }
    else
    {
        tokenNotValid();
    }
}
function addDepartmentPage(){
    document.location.href = "AddDepartment.html"
}
function tokenNotValid()
{
    alert('UNAUTHORIZED USER\nPlease make sure to log in correctly')
    document.location.href = "login.html"
}
function logout(){
    sessionStorage.clear()
    document.location.href = 'login.html'
}
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
<body onload="getAllDepartments()" class="container">
    <div>
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <a class="navbar-brand" href="factory.html">Factory</a>
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="departments.html">Departments</a></li>
                <li class="nav-item"><a class="nav-link" href="employees.html">Employees</a></li>
                <li class="nav-item"><a class="nav-link" href="shifts.html">Shifts</a></li>
            </ul>
        </nav>
    </div>
<h2 id="loggedUser" >Hello, Guest</h2>
<input type="button" value="Log Out" class="btn btn-primary" onclick="logout()">
<button type="button" id="newDepartment" onclick="addDepartmentPage()">Add New Department</button>
<div>
    <table id="table" class="table table-striped">
        <thead class="thead-light">
            <tr>
                <th scope="col">Department Name</th>
                <th scope="col">Department Manager ID</th>
                <th scope="col">Employees List</th>
            </tr>
        </thead>
        <tbody id="tbody">
    
        </tbody>
    </table>    
</div>


</body>
</html>