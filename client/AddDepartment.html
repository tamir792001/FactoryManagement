<!DOCTYPE html>
<html>

<head>
    <title>Add Department</title>
</head>
<script type="text/javascript">
async function createDepartmentRequest()
{
    let dname = document.getElementById('Dname')
    let dmang = document.getElementById('Dmang')
    !dmang.value ? dmang.value = 0 : ""
    let d_id = document.getElementById('Did')

    
    if (validateInput(dname.value, dmang.value, d_id.value))
    {
        const obj = {"name" : dname.value, "manager" : parseInt(dmang.value), "departmentID" : parseInt(d_id.value)};
        console.log(obj)
        let fetchParams =   {
                                method: "POST",
                                headers : {"Content-Type" : "application/json", "x-access-token" : sessionStorage.getItem("token"), "userInformation" : sessionStorage.getItem("userInformation")},
                                body: JSON.stringify(obj)
                            }

        const resp = await fetch('http://localhost:5000/departments', fetchParams)
        const data = await resp.json() 
        if (!Object.keys(data).includes("error"))
        {
            hideMessage()                   
            messegeManagment(resp,data)
            dname.value = "";
            dmang.value = "";
            d_id.value = "";
        }
        else{
            tokenNotValid()
        }
        
    }
    else
    {
        hideMessage()
        messegeManagment()
    }

}
function validateInput(dname, dmang, d_id)
{
    if (dname && dmang && d_id){
        if (isNaN(dname) && !isNaN(dmang) && !isNaN(d_id)){
            return true;
        }
    }
    return false;
}
function messegeManagment(resp,data){
    if (resp !== undefined){
        if (resp.ok){ 
            showSuccess(data)
        }
        else{
            showError(data)
        }
    }
    else{
        showError()
    }
}
function showSuccess(respObj)
{
    hideMessage()
    const successDiv = document.getElementById('success')
    successDiv.style.display = "block"
    successDiv.innerText = respObj.status
}
function showError(respObj)
{
    hideMessage()
    const errorDiv = document.getElementById('error')
    errorDiv.style.display = "block"
    if (respObj === undefined){
        errorDiv.innerText = "Oops!\n"+"Please fill the fields correctly\n"+"Name is word, ID and Manager are numbers"
    }
    else{
        console.log(respObj)
        errorDiv.innerText = respObj.status
    }
    

}
function hideMessage()
{
    const errorDiv = document.getElementById('error')
    errorDiv.style.display = "None"
    const successDiv = document.getElementById('success')
    successDiv.style.display = "None"
}
function toDepartmentsPage(){
    document.location.href = "departments.html"
}
function tokenNotValid()
{
    alert('UNAUTHORIZED USER\nPlease make sure to log in correctly')
    document.location.href = "login.html"
}
function helloUser()
{
    document.getElementById('loggedUser').innerHTML = `Hello, ${JSON.parse(sessionStorage.getItem('userInformation'))?.fullname}`
}
function logout(){
    sessionStorage.clear()
    document.location.href = 'login.html'
}
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
<body onload="helloUser()" class="container">
    <div>
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <a class="navbar-brand" href="factory.html">Factory</a>
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="departments.html">Departments</a></li>
                <li class="nav-item"><a class="nav-link" href="employees.html">Employees</a></li>
                <li class="nav-item"><a class="nav-link" href="shifts.html">Shifts</a></li>
            </ul>
        </nav>
    </div>
<h2 id="loggedUser">Hello, Guest</h2>
<input type="button" value="Log Out" class="btn btn-primary" onclick="logout()">
<div>
    <form class="mb-3 col-sm-5">
        <div>
            <label for="Dname" class="form-label">Department Name</label>
            <input id="Dname" type="text" name="Dname" class="form-control" required>
        </div>
        <div>
            <label for="Dmang" class="form-label">Department Manger</label>
            <input id="Dmang" type="text" name="Dmang" class="form-control" required>
        </div>
        <div>
            <label for="Did" class="form-label">Department ID</label>
            <input id="Did" type="text" name="Did" class="form-control" required>
        </div>
        <div id="error" class="alert alert-danger" role="alert" style="display: none;"></div>
        <div id="success" class="alert alert-success" role="alert" style="display: none;"></div>
        <div>
            <input id="saveBtn" type="button" value="Save" class="btn btn-primary mb-3" onclick="createDepartmentRequest()" >
            <input id="cancelBtn" type="button" value="Cancel" class="btn btn-primary mb-3" onclick="toDepartmentsPage()" >
        </div>
    </form>
</div>
</body>
</html>