<!DOCTYPE html>
<html>

<head>
    <title>Factory</title>
</head>
<script>
async function loginFactory()
{
    const obj = {
                    username : document.getElementById('username').value,
                    email : document.getElementById('email').value
                }
    const fetchParams = {
                            method: "POST",
                            headers : {"Content-Type" : "application/json"},
                            body : JSON.stringify(obj)
                        }
    const resp = await fetch("http://localhost:5000/auth/login", fetchParams)
    const data = await resp.json()
    hideMessage()
    messegeManagment(resp,data)
    if (resp.ok)
    {          
        const userInformation = {fullname : data.name, id : data.userID}                   
        sessionStorage.setItem("token", data.accesstoken)
        sessionStorage.setItem("userInformation",JSON.stringify(userInformation))
        document.getElementById('loggedUser').innerHTML = "Hello, " + data.name
        const timeout = setTimeout(() => {
            hideMessage()
            document.location.href = "factory.html"
            
        },2300)
        
    }
    
}
function getToday()
{
    const d = new Date()
    const year = d.getFullYear();
    const month = d.getMonth() + 1;
    const day = d.getDate();
    return `${year}-${month}-${day}`
}
function messegeManagment(resp,data){
    if (resp !== undefined){
        if (resp.ok){ 
            showSuccess(data)
        }
        else{
            showError(data)
        }
    }
    else{
        showError()
    }
}
function showSuccess(respObj)
{
    const successDiv = document.getElementById("success")
    successDiv.style.display = "block"
    successDiv.innerText = "User Successfully Authenticated\nplease wait..."
}
function showError(respObj)
{
    const errorDiv = document.getElementById("error")
    errorDiv.style.display = "block"
    if (respObj === undefined){
        errorDiv.innerText = "Oops!\n"+
                             "Please fill the fields correctly\n"+
                             "Make sure date is not before today,\n"+
                             "Starting&Ending hours are between 0-23\n"+
                             "Item's not saved"
    }
    else{
        errorDiv.innerText = respObj.error + "\nusername or email are incorrect"
    }
    

}
function hideMessage()
{
    const errorDiv = document.getElementById("error")
    errorDiv.style.display = "None"
    const successDiv = document.getElementById("success")
    successDiv.style.display = "None"
}
function getToday()
{
    const date = new Date()
    const year = date.getFullYear()
    const month = date.getMonth() +1
    const day = date.getDate()

    return `${year}-${month}-${day}`
}
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
<body>
 <h2 id="loggedUser">Hello, Guest</h2>
<div class="container">
    <h1>Factory Login</h1>
    <form>
        <div class="form-group">
            <div class="col-sm-4">
                <label for="username" class="form-label">Username</label>
                <input id="username" type="text" name="username" class="form-control" required>
            </div>
            <div class="col-sm-4">
                <label for="email" class="form-label">E-mail</label>
                <input id="email" type="email" name="email" class="form-control" required>
            </div>
            <div id="error" class="alert alert-danger col-sm-4" role="alert" style="display: none;"></div>
            <div id="success" class="alert alert-success col-sm-4" role="alert" style="display: none;"></div>
            <div class="col-sm-5">
                <input id="loginBtn" type="button" name="loginBtn" value="Log In" class="btn btn-primary" onclick="loginFactory()" >
            </div>
        </div>
        
</div>
</body>
</html>